<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Memory Test</title>
  <style>
    body { text-align:center;
	}
    textarea { width:80%; max-width:400px; 
	}
  </style>
</head>
<body>
  <h2>Memory Test</h2>
  <div id="word">Press Start</div>
  <button id="startBtn">Start</button>

  <div id="recallEasy" style="display:none;">
    <p>Type the words that you recall</p>
    <textarea id="inputEasy" rows="3"></textarea><br>
    <button class="nextBtn" data-stage="easy">Next</button>
  </div>

  <div id="recallMedium" style="display:none;">
    <p>Type the words that you recall</p>
    <textarea id="inputMedium" rows="3"></textarea><br>
    <button class="nextBtn" data-stage="medium">Next</button>
  </div>

  <div id="recallHard" style="display:none;">
    <p>Type the words that you recall</p>
    <textarea id="inputHard" rows="3"></textarea><br>
    <button class="nextBtn" data-stage="hard">Finish</button>
  </div>

  <div id="submitBlock" style="display:none;">
    <button id="prefillBtn">Go to Google Form</button>
  </div>

<script>
const FORM_PREFILL_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSeMaBsnNYlWNqL1MY9AnhXM6pw8QAngiORGpSFofi-hTY_5zg/viewform?usp=pp_url";

const ENTRY = {
  easyText:   "entry.688271684",
  easyScore:  "entry.2099819223",
  medText:    "entry.1612814618",
  medScore:   "entry.1699772145",
  hardText:   "entry.755079465",
  hardScore:  "entry.144112231"
};

const wordLists = {
  easy:   ["dog","cat","book","apple","house"],
  medium: ["candle","bridge","silver","garden","puzzle"],
  hard:   ["labyrinth","fortitude","ephemeral","enigmatic","paradox"]
};
const speeds = { easy:2000, medium:1000, hard:600 };

const stages = ["easy","medium","hard"];
const wordDiv = document.getElementById("word");

document.getElementById("startBtn").onclick = () => runStages();

async function runStages() {
  for (let i=0; i<stages.length; i++) {
    await showStage(stages[i]);
    await showRecall(stages[i]);
  }
  wordDiv.innerText = "Done!";
  document.getElementById("submitBlock").style.display = "block";
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

async function showStage(level) {
  const list = wordLists[level];
  wordDiv.innerText = "Stage: " + level;
  await sleep(1000);
  for (let w of list) {
    wordDiv.innerText = w;
    await sleep(speeds[level]);
    wordDiv.innerText = "";
    await sleep(300);
  }
}

function showRecall(level) {
  return new Promise(resolve=>{
    const block = document.getElementById("recall"+cap(level));
    block.style.display = "block";
    wordDiv.innerText = "Recall " + level + " words";
    const btn = block.querySelector(".nextBtn");
    btn.onclick = ()=>{
      block.style.display = "none"; // hide block so user cannot edit again
      resolve();
    };
  });
}

function scoreRecall(text, words){
  const tokens = text.toLowerCase().split(/\W+/);
  let score=0;
  words.forEach(w=>{ if(tokens.includes(w.toLowerCase())) score++; });
  return score;
}

document.getElementById("prefillBtn").onclick = ()=>{
  const easyText = document.getElementById("inputEasy").value;
  const medText  = document.getElementById("inputMedium").value;
  const hardText = document.getElementById("inputHard").value;
  const easyScore = scoreRecall(easyText, wordLists.easy);
  const medScore  = scoreRecall(medText,  wordLists.medium);
  const hardScore = scoreRecall(hardText, wordLists.hard);

  let url = FORM_PREFILL_BASE;
  url += "&"+ENTRY.easyText+"="+encodeURIComponent(easyText);
  url += "&"+ENTRY.easyScore+"="+easyScore;
  url += "&"+ENTRY.medText+"="+encodeURIComponent(medText);
  url += "&"+ENTRY.medScore+"="+medScore;
  url += "&"+ENTRY.hardText+"="+encodeURIComponent(hardText);
  url += "&"+ENTRY.hardScore+"="+hardScore;

  window.open(url,"_blank");
}

function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}
</script>
</body>
</html>
